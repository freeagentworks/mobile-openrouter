# OpenRouter APIを活用したAIチャットアプリ 要件定義書

## 1. アプリ概要

本アプリは、多様なLLM（大規模言語モデル）を利用できるOpenRouter APIを活用した、モダンで直感的なUIを持つAIチャットアプリケーションである。ユーザー自身のAPIキーを設定することで、様々なAIとの対話体験を提供する。会話履歴やAPIキーはサーバーに送信せず、すべてユーザーのローカル端末内に保存することで、プライバシーを重視した設計とする。

## 2. 目的とゴール

* **目的:**
    * OpenRouter APIの柔軟性を活かし、ユーザーが好みのLLMを選択できる自由なチャット体験を提供する。
    * プライバシーを重視し、ユーザーが安心して利用できる環境を提供する。
    * モダンな技術スタック（Next.js 15, shadcn/ui等）を用いた、高品質なWebアプリケーション開発の実践。

* **ゴール:**
    * ユーザーが自身のOpenRouter APIキーを設定し、AIとテキストおよび画像を用いたチャットができる。
    * ユーザーが利用したいLLMを自由に選択・切り替えできる。
    * 会話履歴がローカル端末に保存され、いつでも閲覧・削除できる。
    * スマートフォン、タブレット、PCなど、あらゆるデバイスで快適に利用できるレスポンシブデザインを実装する。

## 3. ターゲットユーザー

* 最新のAI技術やOpenRouter API、様々なLLMに関心のある開発者、テクノロジー愛好家
* 色々なAIチャットを試してみたい一般ユーザー
* プライバシーを重視し、自身のデータをサーバーに保存したくないユーザー

## 4. 機能要件

### 4.1. チャット機能

* **テキスト入力:** ユーザーがメッセージを入力できるテキストエリアを配置する。
* **メッセージ送信:** 入力されたメッセージを選択されたモデルでOpenRouter APIに送信し、AIとの対話を開始する。
* **画像添付:**
    * ユーザーはローカルから画像ファイルをアップロードできる。
    * 画像が添付された場合、デフォルトで画像解析対応モデル（`meta-llama/llama-4-maverick:free`）を使用して対話を行う。
* **会話表示:**
    * ユーザーとAIの対話が、時系列でチャット形式に表示される。
    * AIからの返答は、ストリーミング形式でリアルタイムに表示し、体感速度を向上させる。
    * AIが応答をストリーミング中であっても、ユーザーは次のメッセージを入力・送信できる。
    * AIの返答に含まれるMarkdown形式のテキスト（コードブロック、リスト等）は適切にレンダリングする。
* **動的モデル管理:**
    * **モデル自動取得:**
        * アプリ起動時にOpenRouter APIから利用可能な全モデルを動的に取得・更新する。
        * フリーモデルとプレミアムモデルを自動分類し、バランス型選択アルゴリズムで多様性を確保する。
        * プロバイダー毎に最大8個のモデルを選択し、偏りのないモデル選択肢を提供する。
    * **デフォルトモデル:**
        * テキストのみの会話では、`google/gemini-2.0-flash-exp:free` を使用する（動的に取得されたフリーモデルから選択）。
        * 画像が添付された会話では、画像対応モデル（Vision機能付き）を自動選択する。
    * **ユーザーによるモデル選択:**
        * フリーモデルとプレミアムモデルを分類表示し、ユーザーが自由に選択・切り替えできる。
        * OpenAI、Anthropic、Google、Meta、xAI、DeepSeekなど主要プロバイダーのモデルを幅広く提供する。
        * 各モデルの詳細情報（プロバイダー、コンテキスト長、画像対応可否、価格）を表示する。

### 4.2. 設定機能

* **設定インターフェース:**
    * 設定画面で、ユーザーが自身のOpenRouter APIキーやLLMのパラメータ（Temperature、Top-pなど）を入力・設定できる。
    * プライバシー設定により、データ収集・学習データ利用・出力公開の許可/拒否を個別に設定可能。
* **プライバシー重視設計:**
    * フリーモデル（`:free`で終わるモデル）使用時は、自動的にデータ収集・学習データ利用・出力公開を「拒否」に設定する。
    * プレミアムモデル使用時は、ユーザーの設定に基づいてプライバシーポリシーを適用する。
* **データ保存:**
    * APIキーや設定値は、ブラウザの`localStorage`を使用してユーザーのローカル端末に保存する。サーバーへの送信は一切行わない。
    * Zustandによる永続化機能で、すべての設定とチャット履歴をローカルで管理する。
* **初期状態:**
    * APIキーが未設定の場合、チャット機能利用時に設定を促すメッセージを表示する。
* **エラーハンドリング:**
    * APIキーが未設定、または不正である場合、API通信時にユーザーフレンドリーなエラーメッセージを表示する。
    * ネットワークエラーやAPI制限エラーに対する詳細な診断とガイダンスを提供する。

### 4.3. 会話履歴管理機能

* **履歴保存:**
    * すべての会話履歴は、`localStorage`または`IndexedDB`を使用してローカル端末に保存する。
* **履歴表示:**
    * アプリ起動時に、前回の会話履歴を自動的に読み込み表示する。
* **履歴削除:**
    * ユーザーが任意のタイミングで、すべての会話履歴を削除できる「履歴を消去」ボタンを設置する。
    * 誤操作防止のため、削除実行前に確認ダイアログを表示する。
* **履歴エクスポート:**
    * 会話履歴全体をMarkdown形式のファイルとしてダウンロードできるボタンを設置する。

## 5. 非機能要件

### 5.1. UI/UXデザイン

* **デザインコンセプト:**
    * スマートフォンでの利用を主要なターゲットとし、モバイルファーストで設計する。
    * ミニマルかつモダンなデザインを採用する。
    * shadcn/uiのコンポーネントをベースに、洗練された外観と操作性を提供する。
    * チャットの吹き出しは、背景色や角丸、影などを工夫し、モダンで視認性の高いデザインとする。
* **ナビゲーション:**
    * スマートフォン表示時、画面下部に固定のナビゲーションバーを配置する。
    * ナビゲーションバーには「チャット」「使い方」「設定」の3つのメニューを配置し、各画面へ遷移できるようにする。
* **アニメーション:**
    * framer-motionを活用し、メッセージの表示やUI要素の遷移に滑らかなアニメーションを導入することで、心地よいユーザー体験を実現する。
* **レスポンシブ対応:**
    * PCの広い画面からスマートフォンの縦長画面まで、画面サイズに応じてレイアウトが最適化される。PC表示時はナビゲーションバーをサイドバーに変更するなどの対応を行う。
* **ダークモード:**
    * ユーザーのOS設定に基づき、ライトモードとダークモードを自動で切り替える機能を実装する。

### 5.2. パフォーマンス

* **初期表示速度:** Next.jsの機能を活用し、高速なページ読み込みを実現する。
* **応答速度:** OpenRouter APIとの通信を最適化し、ユーザーの入力からAIの応答開始までの遅延を最小限に抑える。

### 5.3. セキュリティ

* **APIキーの取り扱い:** APIキーはユーザーのブラウザ内でのみ保持し、外部に送信しない。
* **通信:** OpenRouter APIとの通信はすべてHTTPSで行う。

## 6. 技術スタック

* **フレームワーク:** Next.js 15.5.2 (App Router)
* **UIライブラリ:** React 19.1.0
* **言語:** TypeScript 5.x (厳密な型付け)
* **スタイリング:** Tailwind CSS v4
* **UIコンポーネント:** shadcn/ui (Radix UI ベース)
* **アニメーション:** framer-motion 12.x
* **状態管理:** Zustand 5.x (永続化ミドルウェア付き)
* **データ永続化:** Web Storage API (localStorage)
* **アイコン:** Lucide React
* **API統合:** OpenRouter API v1 (ストリーミング対応)

## 7. 画面構成案

スマートフォンでの利用を前提とし、主要な画面遷移は画面下部のナビゲーションバーで行う。

1.  **下部ナビゲーションバー**
    * 常に画面下部に表示される。
    * 構成要素: 「チャット」アイコン、「使い方」アイコン、「設定」アイコン
2.  **チャット画面 (デフォルト表示)**
    * **ヘッダー:** アプリケーションタイトル、モデル選択ドロップダウン、新規チャット開始ボタン
    * **会話エリア:** ユーザーとAIのメッセージがモダンな吹き出しデザインで表示される。
    * **入力エリア:** テキスト入力フォーム、画像添付ボタン、送信ボタン
3.  **使い方画面**
    * アプリの基本的な使い方、APIキーの取得方法などを記載したマニュアルページ。
    * 静的なコンテンツを表示する。
4.  **設定画面**
    * **APIキー設定:**
        * OpenRouter APIキー入力フィールド
        * 保存ボタン
        * APIキー取得先へのリンク
    * **LLMパラメータ設定:**
        * Temperature, Top-p などのスライダーや入力フィールド
    * **その他:**
        * 会話履歴の全削除ボタン
        * 会話履歴のエクスポートボタン

## 8. 実装済み高度機能

### 8.1. 動的モデル管理システム
* OpenRouter APIからの全モデル自動取得・分類
* バランス型選択アルゴリズムによる多様なモデル選択肢の提供
* フリー/プレミアムモデルの自動分類とプライバシーポリシー適用
* プロバイダー別モデルフィルタリング（主要プロバイダー：OpenAI、Anthropic、Google、Meta、xAI、DeepSeek等）

### 8.2. 高度なプライバシー制御
* モデル種別に応じた自動データポリシー設定
* データ収集・学習データ利用・出力公開の個別制御
* フリーモデル使用時の自動プライバシー保護

### 8.3. マルチモーダル対応
* 画像アップロード機能とBase64変換
* Vision対応モデルの自動選択
* テキスト+画像の統合チャット体験

### 8.4. ストリーミング最適化
* リアルタイムレスポンス表示
* 段階的JSON解析によるスムーズなストリーミング
* 並行メッセージ送信対応

## 9. 将来的な拡張案

* **複数会話スレッド管理:** 複数の会話をタブやサイドバーで切り替えられる機能。
* **システムプロンプト設定:** AIの役割や性格をユーザーがカスタマイズできる機能。
* **ユーザーによるモデルリストのカスタマイズ機能**
* **会話履歴のJSON形式でのエクスポート/インポート機能**
* **PWA機能強化:** オフライン対応とプッシュ通知機能
* **モデル利用統計:** 使用モデル別の利用統計とコスト追跡

## 9. 運用・デプロイ

* **デプロイ環境:** 本アプリケーションは、Vercelへのデプロイを前提として開発を行う。
* **品質保証:** Vercelのデプロイプロセスでは、ビルド時にTypeScriptの型チェックが実行される。デプロイを成功させるため、開発中は常にTypeScriptのエラーを解消するように注意する。